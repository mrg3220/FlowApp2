// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum Role {
  SUPER_ADMIN
  OWNER
  INSTRUCTOR
  STUDENT
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CheckInMethod {
  ADMIN
  KIOSK
  QR_CODE
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  TRANSFERRED
}

enum PaymentGateway {
  STRIPE
  SQUARE
  MANUAL
}

enum BillingCycle {
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PAST_DUE
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CARD
  CASH
  CHECK
  BANK_TRANSFER
  GATEWAY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

// ─── Models ──────────────────────────────────────────────

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  phone        String?
  role         Role     @default(STUDENT)
  bio          String?
  beltRank     String?  @map("belt_rank")
  schoolId     String?  @map("school_id")   // Primary school affiliation (owner/instructor)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  school            School?      @relation("SchoolStaff", fields: [schoolId], references: [id])
  ownedSchools      School[]     @relation("SchoolOwner")
  instructedClasses Class[]      @relation("InstructorClasses")
  enrollments       Enrollment[] @relation("StudentEnrollments")
  checkIns          CheckIn[]    @relation("StudentCheckIns")
  adminCheckIns     CheckIn[]    @relation("AdminCheckIns")
  invoices          Invoice[]    @relation("StudentInvoices")
  payments          Payment[]    @relation("StudentPayments")
  recordedPayments  Payment[]    @relation("RecordedByPayments")
  subscriptions     Subscription[] @relation("StudentSubscriptions")

  @@map("users")
}

model School {
  id        String   @id @default(uuid())
  name      String
  address   String?
  city      String?
  state     String?
  zip       String?
  phone     String?
  email     String?
  ownerId   String   @map("owner_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  owner       User         @relation("SchoolOwner", fields: [ownerId], references: [id])
  staff       User[]       @relation("SchoolStaff")
  classes     Class[]
  enrollments Enrollment[]
  paymentConfig   PaymentConfig?
  membershipPlans MembershipPlan[]
  invoices        Invoice[]
  subscriptions   Subscription[]

  @@map("schools")
}

model Enrollment {
  id         String           @id @default(uuid())
  studentId  String           @map("student_id")
  schoolId   String           @map("school_id")
  status     EnrollmentStatus @default(ACTIVE)
  enrolledAt DateTime         @default(now()) @map("enrolled_at")
  leftAt     DateTime?        @map("left_at")

  // Relations
  student User   @relation("StudentEnrollments", fields: [studentId], references: [id])
  school  School @relation(fields: [schoolId], references: [id])

  // Only one active enrollment per student per school
  @@unique([studentId, schoolId, status])
  @@map("enrollments")
}

model Class {
  id           String     @id @default(uuid())
  name         String
  discipline   String
  skillLevel   SkillLevel @default(ALL_LEVELS) @map("skill_level")
  capacity     Int
  description  String?
  instructorId String     @map("instructor_id")
  schoolId     String     @map("school_id")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  instructor   User            @relation("InstructorClasses", fields: [instructorId], references: [id])
  school       School          @relation(fields: [schoolId], references: [id])
  schedules    ClassSchedule[]
  sessions     ClassSession[]

  @@map("classes")
}

model ClassSchedule {
  id             String    @id @default(uuid())
  classId        String    @map("class_id")
  dayOfWeek      DayOfWeek @map("day_of_week")
  startTime      String    @map("start_time") // "HH:mm" format
  endTime        String    @map("end_time")   // "HH:mm" format
  effectiveFrom  DateTime  @map("effective_from")
  effectiveUntil DateTime? @map("effective_until")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  class    Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  sessions ClassSession[]

  @@map("class_schedules")
}

model ClassSession {
  id          String        @id @default(uuid())
  classId     String        @map("class_id")
  scheduleId  String?       @map("schedule_id")
  sessionDate DateTime      @map("session_date") @db.Date
  startTime   String        @map("start_time")
  endTime     String        @map("end_time")
  status      SessionStatus @default(SCHEDULED)
  qrCode      String        @unique @map("qr_code")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  class    Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  schedule ClassSchedule? @relation(fields: [scheduleId], references: [id])
  checkIns CheckIn[]

  @@map("class_sessions")
}

model CheckIn {
  id           String        @id @default(uuid())
  sessionId    String        @map("session_id")
  studentId    String        @map("student_id")
  method       CheckInMethod
  checkedInBy  String?       @map("checked_in_by")
  checkedInAt  DateTime      @default(now()) @map("checked_in_at")

  // Relations
  session ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User         @relation("StudentCheckIns", fields: [studentId], references: [id])
  admin   User?        @relation("AdminCheckIns", fields: [checkedInBy], references: [id])

  // Prevent duplicate check-ins
  @@unique([sessionId, studentId])
  @@map("check_ins")
}

// ─── Billing Models ─────────────────────────────────────

model PaymentConfig {
  id              String         @id @default(uuid())
  schoolId        String         @unique @map("school_id")
  gateway         PaymentGateway @default(MANUAL)
  gatewayPublicKey String?       @map("gateway_public_key")
  gatewaySecretKey String?       @map("gateway_secret_key")  // encrypted at rest
  gatewayMerchantId String?      @map("gateway_merchant_id") // Square location ID
  currency        String         @default("USD")
  taxRate         Float          @default(0) @map("tax_rate") // percentage e.g. 8.25
  lateFeeAmount   Float          @default(0) @map("late_fee_amount")
  gracePeriodDays Int            @default(7) @map("grace_period_days")
  isActive        Boolean        @default(false) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  school School @relation(fields: [schoolId], references: [id])

  @@map("payment_configs")
}

model MembershipPlan {
  id           String       @id @default(uuid())
  schoolId     String       @map("school_id")
  name         String                           // "Adult Monthly", "Family Plan", "Kids Unlimited"
  description  String?
  price        Float                            // base price
  billingCycle BillingCycle @default(MONTHLY) @map("billing_cycle")
  classCredits Int?         @map("class_credits") // null = unlimited
  isActive     Boolean      @default(true) @map("is_active")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  school   School    @relation(fields: [schoolId], references: [id])
  invoices Invoice[]
  subscriptions Subscription[]

  @@map("membership_plans")
}

model Invoice {
  id           String        @id @default(uuid())
  invoiceNumber String       @unique @map("invoice_number") // e.g. INV-2026-0001
  schoolId     String        @map("school_id")
  studentId    String        @map("student_id")
  planId       String?       @map("plan_id")
  subtotal     Float
  taxAmount    Float         @default(0) @map("tax_amount")
  totalAmount  Float         @map("total_amount")
  status       InvoiceStatus @default(DRAFT)
  dueDate      DateTime      @map("due_date") @db.Date
  paidAt       DateTime?     @map("paid_at")
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  school   School          @relation(fields: [schoolId], references: [id])
  student  User            @relation("StudentInvoices", fields: [studentId], references: [id])
  plan     MembershipPlan? @relation(fields: [planId], references: [id])
  payments Payment[]

  @@map("invoices")
}

model Payment {
  id                 String        @id @default(uuid())
  invoiceId          String        @map("invoice_id")
  amount             Float
  method             PaymentMethod
  gatewayTransactionId String?     @map("gateway_transaction_id") // Stripe/Square txn ID
  recordedById       String?       @map("recorded_by_id")         // staff who recorded manual payment
  notes              String?
  paidAt             DateTime      @default(now()) @map("paid_at")
  createdAt          DateTime      @default(now()) @map("created_at")

  // Relations
  invoice    Invoice @relation(fields: [invoiceId], references: [id])
  student    User    @relation("StudentPayments", fields: [studentId], references: [id])
  recordedBy User?   @relation("RecordedByPayments", fields: [recordedById], references: [id])
  studentId  String  @map("student_id")

  @@map("payments")
}

model Subscription {
  id              String             @id @default(uuid())
  studentId       String             @map("student_id")
  planId          String             @map("plan_id")
  schoolId        String             @map("school_id")
  status          SubscriptionStatus @default(ACTIVE)
  startDate       DateTime           @default(now()) @map("start_date")
  endDate         DateTime?          @map("end_date")
  nextInvoiceDate DateTime?          @map("next_invoice_date") // when the next auto-invoice should be generated
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  student User           @relation("StudentSubscriptions", fields: [studentId], references: [id])
  plan    MembershipPlan @relation(fields: [planId], references: [id])
  school  School         @relation(fields: [schoolId], references: [id])

  @@unique([studentId, planId, schoolId])
  @@map("subscriptions")
}
