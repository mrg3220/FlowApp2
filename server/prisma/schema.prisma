// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum Role {
  SUPER_ADMIN
  OWNER
  INSTRUCTOR
  STUDENT
  EVENT_COORDINATOR
  MARKETING
  SCHOOL_STAFF
  IT_ADMIN
}

enum FamilyRole {
  PRIMARY    // Account holder (parent)
  SECONDARY  // Second parent / guardian
  CHILD      // Child / dependent
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CheckInMethod {
  ADMIN
  KIOSK
  QR_CODE
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  TRANSFERRED
}

enum PaymentGateway {
  STRIPE
  SQUARE
  MANUAL
}

enum BillingCycle {
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PAST_DUE
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CARD
  CASH
  CHECK
  BANK_TRANSFER
  GATEWAY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum RequirementType {
  MIN_ATTENDANCE
  TECHNIQUE
  TIME_IN_RANK
  MIN_AGE
  ESSAY
  CUSTOM
}

enum TestStatus {
  SCHEDULED
  IN_PROGRESS
  PASSED
  FAILED
}

enum NotificationChannel {
  EMAIL
  SMS
  IN_APP
}

enum NotificationType {
  WELCOME
  BIRTHDAY
  MISSED_CLASS
  PAYMENT_REMINDER
  PAYMENT_RECEIPT
  CLASS_CHANGE
  CLASS_CANCELLED
  PROMOTION
  TEST_SCHEDULED
  INVOICE_CREATED
  GENERAL
  LEAD_FOLLOWUP
  TRIAL_REMINDER
}

// ─── F7 Lead/Prospect CRM ───────────────────────────────

enum LeadStatus {
  NEW
  CONTACTED
  TRIAL_SCHEDULED
  TRIAL_COMPLETED
  CONVERTED
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  WALK_IN
  SOCIAL_MEDIA
  ADVERTISING
  EVENT
  OTHER
}

// ─── F10 Digital Waivers ─────────────────────────────────

enum WaiverStatus {
  PENDING
  SIGNED
  EXPIRED
  REVOKED
}

// ─── F11 Retail / Inventory ──────────────────────────────

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

// ─── F15 Instructor Payroll ──────────────────────────────

enum PayrollStatus {
  PENDING
  APPROVED
  PAID
}

// ─── F16 Competition ─────────────────────────────────────

enum MedalType {
  GOLD
  SILVER
  BRONZE
  NONE
}

// ─── F17 Virtual Classes ─────────────────────────────────

enum ContentType {
  VIDEO
  DOCUMENT
  LINK
}

// ─── Title / Certification ───────────────────────────────

enum Title {
  NONE
  LOHAN_CANDIDATE
  LOHAN_CERTIFIED
  SIFU_ASSOCIATE
  SIFU
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
  WITHDRAWN
}

// ─── Events System ───────────────────────────────────────

enum EventType {
  TOURNAMENT
  SEMINAR
  PARTY
  CEREMONY
  WORKSHOP
  OTHER
}

enum EventScope {
  HQ
  SCHOOL
}

enum TicketStatus {
  RESERVED
  PAID
  CANCELLED
  REFUNDED
  CHECKED_IN
}

// ─── Models ──────────────────────────────────────────────

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  phone        String?
  role         Role     @default(STUDENT)
  title        Title    @default(NONE)
  bio          String?
  beltRank     String?  @map("belt_rank")
  schoolId     String?  @map("school_id")   // Primary school affiliation (owner/instructor)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  school            School?      @relation("SchoolStaff", fields: [schoolId], references: [id])
  ownedSchools      School[]     @relation("SchoolOwner")
  instructedClasses Class[]      @relation("InstructorClasses")
  enrollments       Enrollment[] @relation("StudentEnrollments")
  checkIns          CheckIn[]    @relation("StudentCheckIns")
  adminCheckIns     CheckIn[]    @relation("AdminCheckIns")
  invoices          Invoice[]    @relation("StudentInvoices")
  payments          Payment[]    @relation("StudentPayments")
  recordedPayments  Payment[]    @relation("RecordedByPayments")
  subscriptions     Subscription[] @relation("StudentSubscriptions")
  programEnrollments ProgramEnrollment[] @relation("StudentPrograms")
  promotedStudents   Promotion[]   @relation("PromotedByUser")
  testedStudents     BeltTest[]    @relation("TestedByUser")
  reviewedEssays     EssaySubmission[] @relation("EssayReviewer")
  notifications      Notification[]    @relation("UserNotifications")
  notificationPrefs  NotificationPreference[] @relation("UserNotifPrefs")
  dateOfBirth        DateTime?     @map("date_of_birth")
  familyMembers      FamilyMember[] @relation("UserFamilyMember")

  // F7 CRM
  assignedLeads      Lead[]        @relation("AssignedToUser")
  leadActivities     LeadActivity[] @relation("LeadActivityUser")
  // F10 Waivers
  waivers            Waiver[]       @relation("UserWaivers")
  // F11 Retail
  orders             Order[]        @relation("UserOrders")
  // F13 Training Plans
  assignedPlans      TrainingPlanAssignment[] @relation("UserTrainingPlans")
  // F15 Payroll
  payrollEntries     PayrollEntry[] @relation("InstructorPayroll")
  approvedPayroll    PayrollEntry[] @relation("PayrollApprover")
  // Events
  createdEvents      Event[]        @relation("EventCreator")
  eventTickets       EventTicket[]  @relation("UserTickets")
  eventRegistrations EventRegistration[] @relation("UserEventRegs")
  tournamentEntries  TournamentEntry[]   @relation("UserTournamentEntries")
  // Certifications
  certApplications       CertificationApplication[] @relation("UserCertApps")
  reviewedApplications   CertificationApplication[] @relation("AppReviewer")
  // Competitions
  competitionEntries     CompetitionEntry[]         @relation("UserCompetitionEntries")
  // Help
  onboardingProgress     OnboardingProgress[]       @relation("UserOnboarding")
  // F17 Virtual
  videoViews         VideoView[]    @relation("UserVideoViews")
  // IT Admin
  isActive           Boolean        @default(true) @map("is_active")
  disabledAt         DateTime?      @map("disabled_at")
  disabledBy         String?        @map("disabled_by")
  auditLogs          AuditLog[]     @relation("AuditPerformer")

  @@map("users")
}

model School {
  id        String   @id @default(uuid())
  name      String
  address   String?
  city      String?
  state     String?
  zip       String?
  phone     String?
  email     String?
  ownerId   String   @map("owner_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  owner       User         @relation("SchoolOwner", fields: [ownerId], references: [id])
  staff       User[]       @relation("SchoolStaff")
  classes     Class[]
  enrollments Enrollment[]
  paymentConfig      PaymentConfig?
  membershipPlans    MembershipPlan[]
  invoices           Invoice[]
  subscriptions      Subscription[]
  programs           Program[]
  programEnrollments ProgramEnrollment[]
  notificationTemplates NotificationTemplate[]
  notifications         Notification[] @relation("SchoolNotifications")

  families         Family[]     @relation("SchoolFamilies")

  // F7 CRM
  leads              Lead[]       @relation("SchoolLeads")
  // F8 Curriculum
  curriculumItems    CurriculumItem[] @relation("SchoolCurriculum")
  // F10 Waivers
  waiverTemplates    WaiverTemplate[] @relation("SchoolWaiverTemplates")
  waivers            Waiver[]         @relation("SchoolWaivers")
  // F11 Retail
  products           Product[]        @relation("SchoolProducts")
  orders             Order[]          @relation("SchoolOrders")
  // F12 Certificates
  certificateTemplates CertificateTemplate[] @relation("SchoolCertTemplates")
  // F13 Training Plans
  trainingPlans      TrainingPlan[]   @relation("SchoolTrainingPlans")
  // F15 Payroll
  payrollEntries     PayrollEntry[]   @relation("SchoolPayroll")
  // Events
  events             Event[]          @relation("SchoolEvents")
  venues             Venue[]          @relation("SchoolVenues")
  // Competitions
  competitions       Competition[]    @relation("SchoolCompetitions")
  // Branding
  branding           SchoolBranding?  @relation("SchoolBranding")
  // F17 Virtual
  virtualContent     VirtualContent[] @relation("SchoolVirtualContent")

  @@map("schools")
}

// ─── Family / Household ──────────────────────────────────

model Family {
  id        String   @id @default(uuid())
  name      String           // e.g. "Smith Family"
  schoolId  String   @map("school_id")
  email     String?          // Primary contact email
  phone     String?          // Primary contact phone
  notes     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school  School         @relation("SchoolFamilies", fields: [schoolId], references: [id])
  members FamilyMember[]

  @@map("families")
}

model FamilyMember {
  id         String     @id @default(uuid())
  familyId   String     @map("family_id")
  userId     String     @map("user_id")
  familyRole FamilyRole @default(CHILD) @map("family_role")
  createdAt  DateTime   @default(now()) @map("created_at")

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation("UserFamilyMember", fields: [userId], references: [id])

  @@unique([familyId, userId])
  @@map("family_members")
}

model Enrollment {
  id         String           @id @default(uuid())
  studentId  String           @map("student_id")
  schoolId   String           @map("school_id")
  status     EnrollmentStatus @default(ACTIVE)
  enrolledAt DateTime         @default(now()) @map("enrolled_at")
  leftAt     DateTime?        @map("left_at")

  // Relations
  student User   @relation("StudentEnrollments", fields: [studentId], references: [id])
  school  School @relation(fields: [schoolId], references: [id])

  // Only one active enrollment per student per school
  @@unique([studentId, schoolId, status])
  @@map("enrollments")
}

model Class {
  id           String     @id @default(uuid())
  name         String
  discipline   String
  skillLevel   SkillLevel @default(ALL_LEVELS) @map("skill_level")
  capacity     Int
  description  String?
  instructorId String     @map("instructor_id")
  schoolId     String     @map("school_id")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  instructor   User            @relation("InstructorClasses", fields: [instructorId], references: [id])
  school       School          @relation(fields: [schoolId], references: [id])
  schedules    ClassSchedule[]
  sessions     ClassSession[]
  trainingPlanAssignments TrainingPlanAssignment[] @relation("ClassTrainingPlans")

  @@map("classes")
}

model ClassSchedule {
  id             String    @id @default(uuid())
  classId        String    @map("class_id")
  dayOfWeek      DayOfWeek @map("day_of_week")
  startTime      String    @map("start_time") // "HH:mm" format
  endTime        String    @map("end_time")   // "HH:mm" format
  effectiveFrom  DateTime  @map("effective_from")
  effectiveUntil DateTime? @map("effective_until")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  class    Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  sessions ClassSession[]

  @@map("class_schedules")
}

model ClassSession {
  id          String        @id @default(uuid())
  classId     String        @map("class_id")
  scheduleId  String?       @map("schedule_id")
  sessionDate DateTime      @map("session_date") @db.Date
  startTime   String        @map("start_time")
  endTime     String        @map("end_time")
  status      SessionStatus @default(SCHEDULED)
  qrCode      String        @unique @map("qr_code")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  class    Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  schedule ClassSchedule? @relation(fields: [scheduleId], references: [id])
  checkIns CheckIn[]
  payrollEntries PayrollEntry[] @relation("SessionPayroll")

  @@map("class_sessions")
}

model CheckIn {
  id           String        @id @default(uuid())
  sessionId    String        @map("session_id")
  studentId    String        @map("student_id")
  method       CheckInMethod
  checkedInBy  String?       @map("checked_in_by")
  checkedInAt  DateTime      @default(now()) @map("checked_in_at")

  // Relations
  session ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User         @relation("StudentCheckIns", fields: [studentId], references: [id])
  admin   User?        @relation("AdminCheckIns", fields: [checkedInBy], references: [id])

  // Prevent duplicate check-ins
  @@unique([sessionId, studentId])
  @@map("check_ins")
}

// ─── Billing Models ─────────────────────────────────────

model PaymentConfig {
  id              String         @id @default(uuid())
  schoolId        String         @unique @map("school_id")
  gateway         PaymentGateway @default(MANUAL)
  gatewayPublicKey String?       @map("gateway_public_key")
  gatewaySecretKey String?       @map("gateway_secret_key")  // encrypted at rest
  gatewayMerchantId String?      @map("gateway_merchant_id") // Square location ID
  currency        String         @default("USD")
  taxRate         Float          @default(0) @map("tax_rate") // percentage e.g. 8.25
  lateFeeAmount   Float          @default(0) @map("late_fee_amount")
  gracePeriodDays Int            @default(7) @map("grace_period_days")
  isActive        Boolean        @default(false) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  school School @relation(fields: [schoolId], references: [id])

  @@map("payment_configs")
}

model MembershipPlan {
  id           String       @id @default(uuid())
  schoolId     String       @map("school_id")
  name         String                           // "Adult Monthly", "Family Plan", "Kids Unlimited"
  description  String?
  price        Float                            // base price
  billingCycle BillingCycle @default(MONTHLY) @map("billing_cycle")
  classCredits Int?         @map("class_credits") // null = unlimited
  isActive     Boolean      @default(true) @map("is_active")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  school   School    @relation(fields: [schoolId], references: [id])
  invoices Invoice[]
  subscriptions Subscription[]

  @@map("membership_plans")
}

model Invoice {
  id           String        @id @default(uuid())
  invoiceNumber String       @unique @map("invoice_number") // e.g. INV-2026-0001
  schoolId     String        @map("school_id")
  studentId    String        @map("student_id")
  planId       String?       @map("plan_id")
  subtotal     Float
  taxAmount    Float         @default(0) @map("tax_amount")
  totalAmount  Float         @map("total_amount")
  status       InvoiceStatus @default(DRAFT)
  dueDate      DateTime      @map("due_date") @db.Date
  paidAt       DateTime?     @map("paid_at")
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  school   School          @relation(fields: [schoolId], references: [id])
  student  User            @relation("StudentInvoices", fields: [studentId], references: [id])
  plan     MembershipPlan? @relation(fields: [planId], references: [id])
  payments Payment[]

  @@map("invoices")
}

model Payment {
  id                 String        @id @default(uuid())
  invoiceId          String        @map("invoice_id")
  amount             Float
  method             PaymentMethod
  gatewayTransactionId String?     @map("gateway_transaction_id") // Stripe/Square txn ID
  recordedById       String?       @map("recorded_by_id")         // staff who recorded manual payment
  notes              String?
  paidAt             DateTime      @default(now()) @map("paid_at")
  createdAt          DateTime      @default(now()) @map("created_at")

  // Relations
  invoice    Invoice @relation(fields: [invoiceId], references: [id])
  student    User    @relation("StudentPayments", fields: [studentId], references: [id])
  recordedBy User?   @relation("RecordedByPayments", fields: [recordedById], references: [id])
  studentId  String  @map("student_id")

  @@map("payments")
}

model Subscription {
  id              String             @id @default(uuid())
  studentId       String             @map("student_id")
  planId          String             @map("plan_id")
  schoolId        String             @map("school_id")
  status          SubscriptionStatus @default(ACTIVE)
  startDate       DateTime           @default(now()) @map("start_date")
  endDate         DateTime?          @map("end_date")
  nextInvoiceDate DateTime?          @map("next_invoice_date") // when the next auto-invoice should be generated
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  student User           @relation("StudentSubscriptions", fields: [studentId], references: [id])
  plan    MembershipPlan @relation(fields: [planId], references: [id])
  school  School         @relation(fields: [schoolId], references: [id])

  @@unique([studentId, planId, schoolId])
  @@map("subscriptions")
}

// ─── Belt Promotion Models ────────────────────────────────

model Program {
  id               String    @id @default(uuid())
  name             String
  description      String?
  schoolId         String?   @map("school_id")   // null = global program (e.g., Shaolin Wing Chun)
  isGlobal         Boolean   @default(false) @map("is_global")
  hasRankStructure Boolean   @default(true) @map("has_rank_structure")
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  school      School?             @relation(fields: [schoolId], references: [id])
  belts       Belt[]
  enrollments ProgramEnrollment[]
  curriculumItems  CurriculumItem[]  @relation("CurriculumProgram")
  virtualContent   VirtualContent[]  @relation("VirtualContentProgram")

  @@map("programs")
}

model Belt {
  id           String   @id @default(uuid())
  programId    String   @map("program_id")
  name         String
  displayOrder Int      @map("display_order")   // 1 = lowest rank, ascending
  color        String?                          // hex color for UI badge
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")

  program        Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  requirements   BeltRequirement[]
  currentHolders ProgramEnrollment[] @relation("CurrentBelt")
  promotionsTo   Promotion[]         @relation("PromotionToBelt")
  promotionsFrom Promotion[]         @relation("PromotionFromBelt")
  tests          BeltTest[]
  curriculumItems  CurriculumItem[] @relation("CurriculumBelt")
  virtualContent   VirtualContent[] @relation("VirtualContentBelt")

  @@unique([programId, displayOrder])
  @@map("belts")
}

model BeltRequirement {
  id          String          @id @default(uuid())
  beltId      String          @map("belt_id")
  type        RequirementType
  description String
  value       Float?                              // numeric threshold (classes, months, age)
  isRequired  Boolean         @default(true) @map("is_required")
  createdAt   DateTime        @default(now()) @map("created_at")

  belt     Belt                  @relation(fields: [beltId], references: [id], onDelete: Cascade)
  progress RequirementProgress[]

  @@map("belt_requirements")
}

model ProgramEnrollment {
  id            String    @id @default(uuid())
  studentId     String    @map("student_id")
  programId     String    @map("program_id")
  schoolId      String    @map("school_id")
  currentBeltId String?   @map("current_belt_id")
  enrolledAt    DateTime  @default(now()) @map("enrolled_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  student     User    @relation("StudentPrograms", fields: [studentId], references: [id])
  program     Program @relation(fields: [programId], references: [id])
  school      School  @relation(fields: [schoolId], references: [id])
  currentBelt Belt?   @relation("CurrentBelt", fields: [currentBeltId], references: [id])
  progress    RequirementProgress[]
  promotions  Promotion[]
  tests       BeltTest[]
  essays      EssaySubmission[]

  @@unique([studentId, programId, schoolId])
  @@map("program_enrollments")
}

model RequirementProgress {
  id                  String    @id @default(uuid())
  programEnrollmentId String    @map("program_enrollment_id")
  requirementId       String    @map("requirement_id")
  currentValue        Float     @default(0) @map("current_value")
  isComplete          Boolean   @default(false) @map("is_complete")
  completedAt         DateTime? @map("completed_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  enrollment  ProgramEnrollment @relation(fields: [programEnrollmentId], references: [id], onDelete: Cascade)
  requirement BeltRequirement   @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  @@unique([programEnrollmentId, requirementId])
  @@map("requirement_progress")
}

model Promotion {
  id                  String   @id @default(uuid())
  programEnrollmentId String   @map("program_enrollment_id")
  fromBeltId          String?  @map("from_belt_id")
  toBeltId            String   @map("to_belt_id")
  promotedById        String   @map("promoted_by_id")
  notes               String?
  promotedAt          DateTime @default(now()) @map("promoted_at")

  enrollment ProgramEnrollment @relation(fields: [programEnrollmentId], references: [id])
  fromBelt   Belt?             @relation("PromotionFromBelt", fields: [fromBeltId], references: [id])
  toBelt     Belt              @relation("PromotionToBelt", fields: [toBeltId], references: [id])
  promotedBy User              @relation("PromotedByUser", fields: [promotedById], references: [id])
  certificates Certificate[]

  @@map("promotions")
}

model BeltTest {
  id                  String     @id @default(uuid())
  programEnrollmentId String     @map("program_enrollment_id")
  beltId              String     @map("belt_id")
  testDate            DateTime   @map("test_date")
  status              TestStatus @default(SCHEDULED)
  score               Float?
  notes               String?
  testedById          String?    @map("tested_by_id")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  enrollment ProgramEnrollment @relation(fields: [programEnrollmentId], references: [id])
  belt       Belt              @relation(fields: [beltId], references: [id])
  testedBy   User?             @relation("TestedByUser", fields: [testedById], references: [id])
  essays     EssaySubmission[]

  @@map("belt_tests")
}

model EssaySubmission {
  id                  String    @id @default(uuid())
  programEnrollmentId String    @map("program_enrollment_id")
  beltTestId          String?   @map("belt_test_id")
  title               String?
  content             String
  submittedAt         DateTime  @default(now()) @map("submitted_at")
  reviewedById        String?   @map("reviewed_by_id")
  reviewedAt          DateTime? @map("reviewed_at")
  score               Float?
  feedback            String?

  enrollment ProgramEnrollment @relation(fields: [programEnrollmentId], references: [id])
  test       BeltTest?         @relation(fields: [beltTestId], references: [id])
  reviewedBy User?             @relation("EssayReviewer", fields: [reviewedById], references: [id])

  @@map("essay_submissions")
}

// ─── Notification System ─────────────────────────────────

model NotificationTemplate {
  id        String             @id @default(uuid())
  schoolId  String?            @map("school_id")
  type      NotificationType
  channel   NotificationChannel @default(EMAIL)
  subject   String?
  body      String
  isActive  Boolean            @default(true) @map("is_active")
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  school School? @relation(fields: [schoolId], references: [id])

  @@unique([schoolId, type, channel])
  @@map("notification_templates")
}

model Notification {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  schoolId  String?             @map("school_id")
  type      NotificationType
  channel   NotificationChannel
  subject   String?
  body      String
  sentAt    DateTime?           @map("sent_at")
  readAt    DateTime?           @map("read_at")
  metadata  Json?               // extra context: invoiceId, sessionId, etc.
  createdAt DateTime            @default(now()) @map("created_at")

  user   User    @relation("UserNotifications", fields: [userId], references: [id])
  school School? @relation("SchoolNotifications", fields: [schoolId], references: [id])

  @@index([userId, readAt])
  @@map("notifications")
}

model NotificationPreference {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  type      NotificationType
  channel   NotificationChannel
  enabled   Boolean             @default(true)

  user User @relation("UserNotifPrefs", fields: [userId], references: [id])

  @@unique([userId, type, channel])
  @@map("notification_preferences")
}

// ═══════════════════════════════════════════════════════════
// F7 — Lead / Prospect Management (CRM)
// ═══════════════════════════════════════════════════════════

model Lead {
  id          String     @id @default(uuid())
  schoolId    String     @map("school_id")
  firstName   String     @map("first_name")
  lastName    String     @map("last_name")
  email       String?
  phone       String?
  source      LeadSource @default(WALK_IN)
  status      LeadStatus @default(NEW)
  assignedToId String?   @map("assigned_to_id")
  trialDate   DateTime?  @map("trial_date")
  convertedAt DateTime?  @map("converted_at")
  notes       String?
  tags        String?    // comma-separated tags
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  school     School         @relation("SchoolLeads", fields: [schoolId], references: [id])
  assignedTo User?          @relation("AssignedToUser", fields: [assignedToId], references: [id])
  activities LeadActivity[]

  @@map("leads")
}

model LeadActivity {
  id        String   @id @default(uuid())
  leadId    String   @map("lead_id")
  userId    String?  @map("user_id")  // who performed
  action    String   // CALLED, EMAILED, TRIAL_CLASS, NOTE, STATUS_CHANGE
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User? @relation("LeadActivityUser", fields: [userId], references: [id])

  @@map("lead_activities")
}

// ═══════════════════════════════════════════════════════════
// F8 — Curriculum / Technique Library
// ═══════════════════════════════════════════════════════════

model CurriculumItem {
  id          String   @id @default(uuid())
  schoolId    String?  @map("school_id")  // null = global
  programId   String?  @map("program_id")
  beltId      String?  @map("belt_id")
  title       String
  description String?
  category    String?  // "Strikes", "Forms", "Self-defense"
  videoUrl    String?  @map("video_url")
  imageUrl    String?  @map("image_url")
  sortOrder   Int      @default(0) @map("sort_order")
  isPublic    Boolean  @default(true) @map("is_public") // students can view at home
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  school  School?  @relation("SchoolCurriculum", fields: [schoolId], references: [id])
  program Program? @relation("CurriculumProgram", fields: [programId], references: [id])
  belt    Belt?    @relation("CurriculumBelt", fields: [beltId], references: [id])

  @@map("curriculum_items")
}

// ═══════════════════════════════════════════════════════════
// F10 — Digital Waivers & Contracts
// ═══════════════════════════════════════════════════════════

model WaiverTemplate {
  id        String   @id @default(uuid())
  schoolId  String   @map("school_id")
  title     String
  body      String   // HTML or markdown
  version   Int      @default(1)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school  School   @relation("SchoolWaiverTemplates", fields: [schoolId], references: [id])
  waivers Waiver[]

  @@map("waiver_templates")
}

model Waiver {
  id         String       @id @default(uuid())
  templateId String       @map("template_id")
  schoolId   String       @map("school_id")
  userId     String       @map("user_id")
  status     WaiverStatus @default(PENDING)
  signedAt   DateTime?    @map("signed_at")
  signatureData String?   @map("signature_data") // base64 signature image or typed name
  ipAddress  String?      @map("ip_address")
  expiresAt  DateTime?    @map("expires_at")
  createdAt  DateTime     @default(now()) @map("created_at")

  template WaiverTemplate @relation(fields: [templateId], references: [id])
  school   School         @relation("SchoolWaivers", fields: [schoolId], references: [id])
  user     User           @relation("UserWaivers", fields: [userId], references: [id])

  @@map("waivers")
}

// ═══════════════════════════════════════════════════════════
// F11 — Retail / Inventory / Webshop
// ═══════════════════════════════════════════════════════════

model Product {
  id          String   @id @default(uuid())
  schoolId    String?  @map("school_id")  // null = org-wide
  name        String
  description String?
  sku         String?
  price       Float
  costPrice   Float?   @map("cost_price")
  imageUrl    String?  @map("image_url")
  category    String?  // "Uniforms", "Gear", "Merchandise"
  isActive    Boolean  @default(true) @map("is_active")
  isOrgWide   Boolean  @default(false) @map("is_org_wide")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  school     School?     @relation("SchoolProducts", fields: [schoolId], references: [id])
  inventory  Inventory[]
  orderItems OrderItem[]

  @@map("products")
}

model Inventory {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  size      String?  // "S", "M", "L", "XL"
  color     String?
  quantity  Int      @default(0)
  lowStockThreshold Int @default(5) @map("low_stock_threshold")
  updatedAt DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, size, color])
  @@map("inventory")
}

model Order {
  id           String      @id @default(uuid())
  orderNumber  String      @unique @map("order_number")
  schoolId     String?     @map("school_id")
  customerId   String?     @map("customer_id")
  status       OrderStatus @default(PENDING)
  subtotal     Float
  taxAmount    Float       @default(0) @map("tax_amount")
  totalAmount  Float       @map("total_amount")
  notes        String?
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  school   School?     @relation("SchoolOrders", fields: [schoolId], references: [id])
  customer User?       @relation("UserOrders", fields: [customerId], references: [id])
  // Guest checkout
  guestName    String?  @map("guest_name")
  guestEmail   String?  @map("guest_email")
  guestPhone   String?  @map("guest_phone")
  items    OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String @map("order_id")
  productId String @map("product_id")
  quantity  Int
  unitPrice Float  @map("unit_price")
  size      String?
  color     String?

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// ═══════════════════════════════════════════════════════════
// F12 — Belt Certificate Designer
// ═══════════════════════════════════════════════════════════

model CertificateTemplate {
  id          String   @id @default(uuid())
  schoolId    String?  @map("school_id")  // null = global
  name        String
  description String?
  layoutJson  String   @map("layout_json") // JSON: positions of fields, logo, borders
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  school       School?       @relation("SchoolCertTemplates", fields: [schoolId], references: [id])
  certificates Certificate[]

  @@map("certificate_templates")
}

model Certificate {
  id           String   @id @default(uuid())
  templateId   String   @map("template_id")
  promotionId  String   @map("promotion_id")
  studentName  String   @map("student_name")
  beltName     String   @map("belt_name")
  programName  String   @map("program_name")
  schoolName   String   @map("school_name")
  awardedDate  DateTime @map("awarded_date")
  pdfUrl       String?  @map("pdf_url")
  createdAt    DateTime @default(now()) @map("created_at")

  template  CertificateTemplate @relation(fields: [templateId], references: [id])
  promotion Promotion           @relation(fields: [promotionId], references: [id])

  @@map("certificates")
}

// ═══════════════════════════════════════════════════════════
// F13 — Training Plans
// ═══════════════════════════════════════════════════════════

model TrainingPlan {
  id          String   @id @default(uuid())
  schoolId    String   @map("school_id")
  name        String
  description String?
  category    String?  // "Conditioning", "Technique", "Sparring"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  school      School                  @relation("SchoolTrainingPlans", fields: [schoolId], references: [id])
  exercises   TrainingPlanExercise[]
  assignments TrainingPlanAssignment[]

  @@map("training_plans")
}

model TrainingPlanExercise {
  id          String  @id @default(uuid())
  planId      String  @map("plan_id")
  name        String
  description String?
  sets        Int?
  reps        String? // "10" or "30 sec"
  duration    String? // "5 min"
  videoUrl    String? @map("video_url")
  sortOrder   Int     @default(0) @map("sort_order")

  plan TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("training_plan_exercises")
}

model TrainingPlanAssignment {
  id         String    @id @default(uuid())
  planId     String    @map("plan_id")
  userId     String?   @map("user_id")     // assigned to specific student
  classId    String?   @map("class_id")    // or assigned to a class
  assignDate DateTime  @map("assign_date") @db.Date
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")

  plan  TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  user  User?        @relation("UserTrainingPlans", fields: [userId], references: [id])
  class Class?       @relation("ClassTrainingPlans", fields: [classId], references: [id])

  @@map("training_plan_assignments")
}

// ═══════════════════════════════════════════════════════════
// F15 — Instructor Payroll / Hours Tracking
// ═══════════════════════════════════════════════════════════

model PayrollEntry {
  id            String        @id @default(uuid())
  schoolId      String        @map("school_id")
  instructorId  String        @map("instructor_id")
  sessionId     String?       @map("session_id")
  hoursWorked   Float         @map("hours_worked")
  hourlyRate    Float         @map("hourly_rate")
  totalPay      Float         @map("total_pay")
  date          DateTime      @db.Date
  status        PayrollStatus @default(PENDING)
  approvedById  String?       @map("approved_by_id")
  approvedAt    DateTime?     @map("approved_at")
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  school     School        @relation("SchoolPayroll", fields: [schoolId], references: [id])
  instructor User          @relation("InstructorPayroll", fields: [instructorId], references: [id])
  session    ClassSession?  @relation("SessionPayroll", fields: [sessionId], references: [id])
  approvedBy User?         @relation("PayrollApprover", fields: [approvedById], references: [id])

  @@map("payroll_entries")
}

// ═══════════════════════════════════════════════════════════
// EVENTS SYSTEM (replaces F16 Competitions)
// ═══════════════════════════════════════════════════════════

model Venue {
  id           String   @id @default(uuid())
  name         String
  address      String?
  city         String?
  state        String?
  zipCode      String?  @map("zip_code")
  capacity     Int?
  isSchool     Boolean  @default(false) @map("is_school")
  schoolId     String?  @map("school_id")
  contactName  String?  @map("contact_name")
  contactPhone String?  @map("contact_phone")
  contactEmail String?  @map("contact_email")
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  school School? @relation("SchoolVenues", fields: [schoolId], references: [id])
  events Event[]

  @@map("venues")
}

model Event {
  id                   String     @id @default(uuid())
  name                 String
  description          String?
  eventType            EventType  @map("event_type")
  scope                EventScope @default(SCHOOL)
  schoolId             String?    @map("school_id")      // null = HQ event
  venueId              String?    @map("venue_id")
  startDate            DateTime   @map("start_date")
  endDate              DateTime?  @map("end_date")
  isPublic             Boolean    @default(false) @map("is_public")
  ticketPrice          Float?     @map("ticket_price")
  maxCapacity          Int?       @map("max_capacity")
  registrationDeadline DateTime?  @map("registration_deadline")
  imageUrl             String?    @map("image_url")
  createdById          String     @map("created_by_id")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")

  school        School?             @relation("SchoolEvents", fields: [schoolId], references: [id])
  venue         Venue?              @relation(fields: [venueId], references: [id])
  createdBy     User                @relation("EventCreator", fields: [createdById], references: [id])
  tickets       EventTicket[]
  registrations EventRegistration[]
  tournamentEntries TournamentEntry[]

  @@map("events")
}

model EventTicket {
  id          String       @id @default(uuid())
  eventId     String       @map("event_id")
  userId      String?      @map("user_id")      // null for guest
  guestName   String?      @map("guest_name")
  guestEmail  String?      @map("guest_email")
  guestPhone  String?      @map("guest_phone")
  quantity    Int          @default(1)
  unitPrice   Float        @map("unit_price")
  totalPrice  Float        @map("total_price")
  status      TicketStatus @default(RESERVED)
  paymentRef  String?      @map("payment_ref")
  purchasedAt DateTime?    @map("purchased_at")
  checkedInAt DateTime?    @map("checked_in_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User? @relation("UserTickets", fields: [userId], references: [id])

  @@map("event_tickets")
}

model EventRegistration {
  id           String   @id @default(uuid())
  eventId      String   @map("event_id")
  userId       String   @map("user_id")
  status       String   @default("REGISTERED") // REGISTERED, WAITLISTED, CANCELLED
  notes        String?
  registeredAt DateTime @default(now()) @map("registered_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation("UserEventRegs", fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@map("event_registrations")
}

model TournamentEntry {
  id          String    @id @default(uuid())
  eventId     String    @map("event_id")
  userId      String    @map("user_id")
  weightClass String?   @map("weight_class")
  division    String?
  medalType   MedalType @default(NONE) @map("medal_type")
  placement   Int?
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation("UserTournamentEntries", fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@map("tournament_entries")
}

// ═══════════════════════════════════════════════════════════
// COMPETITIONS
// ═══════════════════════════════════════════════════════════

model Competition {
  id          String    @id @default(uuid())
  name        String
  description String?
  location    String?
  eventDate   DateTime  @map("event_date")
  schoolId    String?   @map("school_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  school  School?            @relation("SchoolCompetitions", fields: [schoolId], references: [id])
  entries CompetitionEntry[]

  @@map("competitions")
}

model CompetitionEntry {
  id            String    @id @default(uuid())
  competitionId String    @map("competition_id")
  studentId     String    @map("student_id")
  division      String?
  weightClass   String?   @map("weight_class")
  placement     Int?
  medal         MedalType @default(NONE)
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  student     User        @relation("UserCompetitionEntries", fields: [studentId], references: [id])

  @@unique([competitionId, studentId])
  @@map("competition_entries")
}

// ═══════════════════════════════════════════════════════════
// CERTIFICATION / APPLICATION PROCESS
// ═══════════════════════════════════════════════════════════

model CertificationApplication {
  id              String            @id @default(uuid())
  userId          String            @map("user_id")
  targetTitle     Title             @map("target_title")
  status          ApplicationStatus @default(DRAFT)
  applicationData Json?             @map("application_data")   // flexible form data
  feeAmount       Float?            @map("fee_amount")
  feePaid         Boolean           @default(false) @map("fee_paid")
  submittedAt     DateTime?         @map("submitted_at")
  reviewedAt      DateTime?         @map("reviewed_at")
  reviewedById    String?           @map("reviewed_by_id")
  reviewNotes     String?           @map("review_notes")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  user       User  @relation("UserCertApps", fields: [userId], references: [id])
  reviewedBy User? @relation("AppReviewer", fields: [reviewedById], references: [id])

  @@map("certification_applications")
}

// ═══════════════════════════════════════════════════════════
// BRANDING
// ═══════════════════════════════════════════════════════════

model OrgBranding {
  id              String   @id @default(uuid())
  logoUrl         String?  @map("logo_url")
  logoLightUrl    String?  @map("logo_light_url")
  primaryColor    String   @default("#1a1a2e") @map("primary_color")
  secondaryColor  String   @default("#e94560") @map("secondary_color")
  accentColor     String   @default("#0f3460") @map("accent_color")
  fontFamily      String   @default("Inter, sans-serif") @map("font_family")
  tagline         String?
  guidelines      Json?    // Full branding guide document
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("org_branding")
}

model SchoolBranding {
  id              String   @id @default(uuid())
  schoolId        String   @unique @map("school_id")
  logoUrl         String?  @map("logo_url")
  bannerUrl       String?  @map("banner_url")
  primaryColor    String?  @map("primary_color")
  secondaryColor  String?  @map("secondary_color")
  description     String?
  welcomeMessage  String?  @map("welcome_message")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  school School @relation("SchoolBranding", fields: [schoolId], references: [id])

  @@map("school_branding")
}

// ═══════════════════════════════════════════════════════════
// HELP SYSTEM
// ═══════════════════════════════════════════════════════════

model HelpArticle {
  id          String   @id @default(uuid())
  title       String
  content     String
  category    String   // "Getting Started", "Schools", "Events", etc.
  roles       String[] // Which roles can see this article
  tags        String[]
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("help_articles")
}

model OnboardingProgress {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  stepKey     String   @map("step_key")  // "welcome", "first_class", "first_checkin"
  completedAt DateTime @default(now()) @map("completed_at")

  user User @relation("UserOnboarding", fields: [userId], references: [id])

  @@unique([userId, stepKey])
  @@map("onboarding_progress")
}

// ═══════════════════════════════════════════════════════════
// F17 — Online / Virtual Classes
// ═══════════════════════════════════════════════════════════

model VirtualContent {
  id          String      @id @default(uuid())
  schoolId    String?     @map("school_id")
  title       String
  description String?
  contentType ContentType @default(VIDEO) @map("content_type")
  url         String      // video URL, document link
  thumbnailUrl String?    @map("thumbnail_url")
  category    String?     // "Beginner", "Advanced", "Sparring Drills"
  programId   String?     @map("program_id")
  beltId      String?     @map("belt_id")
  duration    Int?        // minutes
  isPublic    Boolean     @default(false) @map("is_public")
  sortOrder   Int         @default(0) @map("sort_order")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  school  School?     @relation("SchoolVirtualContent", fields: [schoolId], references: [id])
  program Program?    @relation("VirtualContentProgram", fields: [programId], references: [id])
  belt    Belt?       @relation("VirtualContentBelt", fields: [beltId], references: [id])
  views   VideoView[]

  @@map("virtual_content")
}

model VideoView {
  id        String   @id @default(uuid())
  contentId String   @map("content_id")
  userId    String   @map("user_id")
  watchedSeconds Int @default(0) @map("watched_seconds")
  completed Boolean  @default(false)
  viewedAt  DateTime @default(now()) @map("viewed_at")

  content VirtualContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user    User           @relation("UserVideoViews", fields: [userId], references: [id])

  @@index([contentId, userId])
  @@map("video_views")
}

// ═══════════════════════════════════════════════════════════
// IT Administration & SRE
// ═══════════════════════════════════════════════════════════

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_DISABLED
  USER_ENABLED
  USER_ROLE_CHANGED
  USER_PASSWORD_RESET
  SESSION_REVOKED
  SETTING_CHANGED
  LOGIN_SUCCESS
  LOGIN_FAILED
  SYSTEM_CONFIG_CHANGED
}

model AuditLog {
  id          String      @id @default(uuid())
  performerId String?     @map("performer_id")
  action      AuditAction
  targetType  String?     @map("target_type")   // "User", "School", "Setting"
  targetId    String?     @map("target_id")
  details     Json?       // Structured change details
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  createdAt   DateTime    @default(now()) @map("created_at")

  performer   User?       @relation("AuditPerformer", fields: [performerId], references: [id])

  @@index([performerId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  category  String   @default("general")
  label     String?  // Human-readable label
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@index([category])
  @@map("system_settings")
}
