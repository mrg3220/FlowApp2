name: CI — FlowApp2

on:
  push:
    branches: [main, 'feature/**']
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ─── Lint & Build ──────────────────────────────────────
  server-check:
    name: Server — Lint & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: server/package-lock.json

      - run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Validate Prisma Schema
        run: npx prisma validate

      - name: Check for known vulnerabilities
        run: npm audit --omit=dev --audit-level=high || true

  client-check:
    name: Client — Lint & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: client/package-lock.json

      - run: npm ci

      - name: Build production bundle
        run: npm run build

      - name: Check for known vulnerabilities
        run: npm audit --omit=dev --audit-level=high || true

  # ─── Integration Tests (against real PostgreSQL) ───────
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [server-check]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: flowapp_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_user -d flowapp_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: server

    env:
      DATABASE_URL: postgresql://test_user:test_password@localhost:5432/flowapp_test?schema=public
      JWT_SECRET: ci-test-secret-not-for-production-use-12345678901234567890
      JWT_EXPIRES_IN: 15m
      NODE_ENV: test
      PORT: 3001
      CORS_ORIGIN: '*'
      REDIS_URL: redis://localhost:6379

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: server/package-lock.json

      - run: npm ci

      - name: Run Prisma migrations
        run: npx prisma migrate deploy

      - name: Seed test database
        run: node prisma/seed.js

      - name: Start server
        run: node src/index.js &
        env:
          NODE_ENV: test

      - name: Wait for server health
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "Server is healthy"
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done
          echo "Server failed to start"
          exit 1

      - name: Run API regression tests
        run: node test/regression_test.js

  # ─── Docker Build Validation ───────────────────────────
  docker-build:
    name: Docker — Build Images
    runs-on: ubuntu-latest
    needs: [server-check, client-check]

    steps:
      - uses: actions/checkout@v6

      - name: Build server image
        run: docker build -t flowapp2-server:ci ./server

      - name: Build client image
        run: docker build -t flowapp2-client:ci ./client

      - name: Verify server image health check
        run: |
          docker network create test-net
          docker run -d --name test-db --network test-net \
            -e POSTGRES_DB=flowapp -e POSTGRES_USER=test -e POSTGRES_PASSWORD=test \
            postgres:16-alpine
          sleep 5
          docker run -d --name test-redis --network test-net redis:7-alpine
          sleep 3
          docker run -d --name test-server --network test-net \
            -e DATABASE_URL="postgresql://test:test@test-db:5432/flowapp?schema=public" \
            -e JWT_SECRET="ci-test-secret-not-for-production-use-12345678901234567890" \
            -e JWT_EXPIRES_IN="15m" \
            -e NODE_ENV="test" \
            -e PORT="3001" \
            -e CORS_ORIGIN="*" \
            -e REDIS_URL="redis://test-redis:6379" \
            -p 3001:3001 \
            flowapp2-server:ci \
            sh -c "npx prisma migrate deploy && node src/index.js"
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "Server container is healthy"
              exit 0
            fi
            sleep 2
          done
          docker logs test-server
          echo "Container health check failed"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          docker rm -f test-server test-db test-redis 2>/dev/null || true
          docker network rm test-net 2>/dev/null || true
